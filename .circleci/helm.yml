version: 2.1


orbs:
  general: premiscale/general@dev:01763b8c3a8e0b307930a921eca7f2b2faa81823
  slack: circleci/slack@4.13.2


workflows:
  helm:
    jobs:
      - general/helm-lint:
          name: helm lint [helm/cluster-checkin]
          chart-path: helm/$CIRCLE_PROJECT_REPONAME

      # develop

      - general/docker-ecr:
          name: docker [cluster-checkin] [develop]
          image-name: cluster-checkin
          branch-tag: true
          context:
            - aws-development
          requires:
            - helm lint [helm/cluster-checkin]
          path: .
          tag: 0.0.<< pipeline.number >>
          filters:
            branches:
              ignore:
                - master

      - general/helm-release-ecr:
          name: helm build and push [helm/cluster-checkin] [develop]
          context:
            - aws-development
          version: 0.0.<< pipeline.number >>
          chart-name-postfix: chart
          image-tag: 0.0.<< pipeline.number >>
          image-tag-path: .cron.image.tag
          requires:
            - helm lint [helm/cluster-checkin]
          filters:
            branches:
              ignore:
                - master

      ##

      - slack/on-hold:
          context: slack
          requires:
            - docker [cluster-checkin] [develop]
            - helm build and push [helm/cluster-checkin] [develop]
          filters:
            branches:
              ignore:
                - master

      - request-approval:
          name: Helm upgrade approval [develop]
          requires:
            - docker [cluster-checkin] [develop]
            - helm build and push [helm/cluster-checkin] [develop]
          type: approval
          filters:
            branches:
              ignore:
                - master

      ##

      - general/helm-upgrade:
          name: helm upgrade install [helm/cluster-checkin] [develop]
          cluster: $CHELSEA_CLUSTER
          namespace: crons
          repo: $HELM_DEVELOP_REPOSITORY_URL
          version: 0.0.<< pipeline.number >>
          additional-values: |
            --set global.image.registry="$DOCKER_DEVELOP_DOMAIN" --set cron.image.pullSecrets[0]=nexus-docker-registry --set cron.env[0].name=CLUSTER_ID,cron.env[0].value="$LOFT_CHELSEA_CLUSTER_ID"
          requires:
            - Helm upgrade approval [develop]
          context:
            - kubeconfig
            - nexus
          filters:
            branches:
              ignore:
                - master

      # master

      - general/docker-ecr:
          name: docker [cluster-checkin] [master]
          image-name: cluster-checkin
          branch-tag: true
          context:
            - aws-development
          requires:
            - helm lint [helm/cluster-checkin]
          path: .
          tag: 0.0.<< pipeline.number >>
          filters:
            branches:
              only:
                - master

      - general/helm-release-ecr:
          name: helm build and push [helm/cluster-checkin] [master]
          context:
            - aws-development
          repo: $HELM_MASTER_REPOSITORY_URL
          chart-name-postfix: chart
          version: 0.0.<< pipeline.number >>
          image-tag: 0.0.<< pipeline.number >>
          image-tag-path: .cron.image.tag
          requires:
            - helm lint [helm/cluster-checkin]
            - docker [cluster-checkin] [master]
          filters:
            branches:
              only:
                - master

      ##

      - slack/on-hold:
          context: slack
          requires:
            - helm build and push [helm/cluster-checkin] [master]
            - docker [cluster-checkin] [master]
          filters:
            branches:
              only:
                - master

      - request-approval:
          name: Helm upgrade approval [master]
          type: approval
          requires:
            - helm build and push [helm/cluster-checkin] [master]
            - docker [cluster-checkin] [master]
          filters:
            branches:
              only:
                - master

      ##

      - general/helm-upgrade:
          name: helm upgrade install [helm/cluster-checkin] [master]
          cluster: $CHELSEA_CLUSTER
          namespace: crons
          repo: $HELM_MASTER_REPOSITORY_URL
          version: 0.0.<< pipeline.number >>
          additional-values: |
            --set global.image.registry="$DOCKER_MASTER_DOMAIN" --set cron.image.pullSecrets[0]=nexus-docker-registry --set cron.env[0].name=CLUSTER_ID,cron.env[0].value="$LOFT_CHELSEA_CLUSTER_ID"
          requires:
            - Helm upgrade approval [master]
          context:
            - kubeconfig
            - nexus
          filters:
            branches:
              only:
                - master
version: 2.1

setup: true


orbs:
  dynamic: bjd2385/dynamic-continuation@3.8.1
  general: premiscale/general@dev:ce11aaf426a2f8cc068a7d08459b0e74216f7540
  slack: circleci/slack@4.13.2


workflows:
  cluster-checkin:
    jobs:
      # Development branches

      - dynamic/continue:
          context: circleci
          base-revision: master

      # On tag

      - slack/on-hold:
          context: slack
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      - request-approval:
          name: Artifact generation approval
          type: approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      - general/github-release:
          context:
            - github
            - circleci
          requires:
            - Artifact generation approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      - general/docker-ecr:
          name: docker [cluster-checkin] [tag]
          image-name: cluster-checkin
          tag: $CIRCLE_TAG
          context:
            - aws-development
          requires:
            - Artifact generation approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      - general/docker-hub:
          name: dockerhub [cluster-checkin] [tag]
          image-name: cluster-checkin
          tag: $CIRCLE_TAG
          context:
            - dockerhub
          requires:
            - Artifact generation approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      - general/helm-release-ecr:
          name: helm build and push [helm/cluster-checkin] [tag]
          context:
            - aws-development
          version: $CIRCLE_TAG
          image-tag: $CIRCLE_TAG
          image-tag-path: .cron.image.tag
          requires:
            - Artifact generation approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      ##

      - slack/on-hold:
          context: slack
          requires:
            - helm build and push [helm/cluster-checkin] [tag]
            - dockerhub [cluster-checkin] [tag]
            - docker [cluster-checkin] [tag]
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      - request-approval:
          name: Helm upgrade approval
          type: approval
          requires:
            - helm build and push [helm/cluster-checkin] [tag]
            - dockerhub [cluster-checkin] [tag]
            - docker [cluster-checkin] [tag]
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      ##

      - general/helm-upgrade:
          name: helm upgrade install [helm/cluster-checkin] [tag]
          cluster: $CHELSEA_CLUSTER
          namespace: crons
          repo: $HELM_REPOSITORY_URL
          additional-values: |
            --set global.image.registry="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/$CIRCLE_PROJECT" --set cron.image.pullSecrets[0]=ecr-docker-registry --set cron.env[0].name=CLUSTER_ID,cron.env[0].value="$LOFT_CHELSEA_CLUSTER_ID"
          requires:
            - Helm upgrade approval
          context:
            - kubeconfig
            - aws-development
            - nexus
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/